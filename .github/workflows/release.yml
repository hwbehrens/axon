name: release

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> "$GITHUB_ENV"

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: axon
          key: ${{ matrix.target }}

      - name: Build
        working-directory: axon
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package
        run: |
          BIN=axon/target/${{ matrix.target }}/release/axon
          ARCHIVE=axon-${{ github.ref_name }}-${{ matrix.target }}.tar.gz
          tar czf "$ARCHIVE" -C "$(dirname "$BIN")" "$(basename "$BIN")"
          echo "ARCHIVE=$ARCHIVE" >> "$GITHUB_ENV"

      - name: Upload to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload "${{ github.ref_name }}" "${{ env.ARCHIVE }}"

  homebrew-tap-update:
    name: homebrew tap update
    needs: build
    if: ${{ secrets.HOMEBREW_TAP_TOKEN != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Update Formula/axon.rb in homebrew-axon
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          RELEASE_TAG: ${{ github.ref_name }}
          TAP_REPO: hwbehrens/homebrew-axon
          FORMULA_PATH: Formula/axon.rb
        run: |
          set -euo pipefail

          tarball_url="https://github.com/hwbehrens/axon/archive/refs/tags/${RELEASE_TAG}.tar.gz"
          curl -fsSL "$tarball_url" -o /tmp/axon-release.tar.gz
          sha256="$(shasum -a 256 /tmp/axon-release.tar.gz | awk '{print $1}')"

          response="$(gh api "repos/${TAP_REPO}/contents/${FORMULA_PATH}?ref=main")"
          formula_sha="$(jq -r '.sha' <<<"$response")"
          formula_content="$(jq -r '.content' <<<"$response" | tr -d '\n' | base64 --decode)"

          current_url="$(grep -E '^  url "' <<<"$formula_content" | sed -E 's/^  url "([^"]+)".*/\1/')"
          current_sha256="$(grep -E '^  sha256 "' <<<"$formula_content" | sed -E 's/^  sha256 "([^"]+)".*/\1/')"

          if [[ "$current_url" == "$tarball_url" && "$current_sha256" == "$sha256" ]]; then
            {
              echo "### Homebrew Tap Status"
              echo ""
              echo "- \`${TAP_REPO}\` is already up to date for \`${RELEASE_TAG}\`."
              echo "- URL: \`${current_url}\`"
              echo "- SHA256: \`${current_sha256}\`"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          updated_formula="$(printf '%s\n' "$formula_content" \
            | sed -E "s|^  url \".*\"$|  url \"${tarball_url}\"|" \
            | sed -E "s|^  sha256 \".*\"$|  sha256 \"${sha256}\"|")"
          updated_content="$(printf '%s' "$updated_formula" | base64 | tr -d '\n')"

          commit_url="$(gh api "repos/${TAP_REPO}/contents/${FORMULA_PATH}" \
            --method PUT \
            -f message="axon ${RELEASE_TAG}" \
            -f content="$updated_content" \
            -f sha="$formula_sha" \
            -f branch="main" \
            --jq '.commit.html_url')"

          {
            echo "### Homebrew Tap Status"
            echo ""
            echo "- Updated \`${TAP_REPO}\` to \`${RELEASE_TAG}\`."
            echo "- URL: \`${tarball_url}\`"
            echo "- SHA256: \`${sha256}\`"
            echo "- Commit: ${commit_url}"
          } >> "$GITHUB_STEP_SUMMARY"

  homebrew-tap-update-missing-secret:
    name: homebrew tap update (missing token)
    needs: build
    if: ${{ secrets.HOMEBREW_TAP_TOKEN == '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Warn when HOMEBREW_TAP_TOKEN is not configured
        run: |
          {
            echo "### Homebrew Tap Status"
            echo ""
            echo "- Skipped automatic tap update: \`HOMEBREW_TAP_TOKEN\` is not configured."
            echo "- Configure this repository secret to enable automatic updates to \`hwbehrens/homebrew-axon\`."
          } >> "$GITHUB_STEP_SUMMARY"
